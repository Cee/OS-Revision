# Lec 10 文件管理

### 文件的基本概念

> 文件系统是操作系统中负责存取和管理信息的模块,它用统一的方式管理用户和系统信息的存储,检索,更新,共享和保护,并为用户提供一整套方便有效的文件使用和操作方法

+ 文件分为逻辑文件和物理文件

	- 对用户而言,文件系统提供"按名存取"的方法,实现文件目录建立和维护
	
	- 对系统而言,要采用特定的数据结构和有效算法实现文件的逻辑到存储的映射
	
+ 文件的基本概念

	- 文件概念
	
		> 由文件名字标识的一组信息的集合
	
	- 文件命名
		
		> 字母或数字组成的字母数字串,它的格式和长度因系统而异
	
	- 文件类型(Slides: pp15-16)
		
	- 文件属性
		
		+ 基本属性
		
		+ 类型属性
		
		+ 保护属性
		
		+ 管理属性
		
		+ 控制属性
	
	- 文件存取方法
	
		+ 顺序存取
		
			- 都在上次的基础上进行
			
			- 固定长记录的顺序文件采用随机访问
		
		+ 直接存取 
		
			- 块常常划成等长,作为最小单位
			
		+ 索引存取
		
			- 按名搜索,再查找到所需记录
	
### 文件目录

+ 文件控制块 文件目录 目录文件
	
	> 文件目录项又称文件控制块FCB(File Control Block) 
	
	+ 文件目录项内容	
	
		- 文件标识和控制信息

		- 文件逻辑结构信息
		
		- 文件物理结构信息
		
		- 文件使用信息
		
		- 文件管理信息
	
	+ 文件目录:为了加快文件的查找,通常把FCB集中起来进行管理,组成文件目录
		
	+ 文件目录项:文件目录包含许多目录项,目录项有两种,用于描述子目录和文件FCB
	
	+ 目录文件:全部由目录项构成的文件称为目录文件
	
	+ Linux: 文件名+inode号
	
		- 文件系统中的每个文件都有一个磁盘inode与之对应
		
		- 数据块索引在union结构的每个具体文件系统中,i_data[15]数组给出数据块地址索引,前12项为直接索引,第13项为一次间接索引,第14项为二次间接索引,第15项为三次间接索引
		
		- 开辟活动inode表,磁盘inode反映文件静态特性,活动inode反映文件动态特性

+ 层次目录结构

	- 路径名

		+ 绝对路径名

		+ 相对路径名

	- 树型结构

		+ 优点

			- 较好反映了数据的层次关系

			- 不同文件可以重名
	
	- 多父目录
			
### 文件组织与数据存储

+ 文件存储

	- 卷是存储介质的物理单位,块是存储介质上连续信息所组成的一个区域

+ 文件的逻辑结构

	- 流式文件:文件内的数据不再组成记录

	- 记录式文件:包含若干逻辑记录,逻辑记录是文件中按信息在逻辑上的独立含意划分的信息单位

		+ 域(field)是基本数据单元

		+ 记录(record)是一组相关的域的集合

		+ 文件(file)是一组相似记录的集合

		+ 数据库(database)是一组相关的数据集合

		+ 分类

			- 记录式顺序文件:顺序生成和访问

			- 记录式索引顺序文件:表项包含记录键和索引指针,记录键由应用程序确定,含有get/putrecord两个系统调用来获得一个指定记录或者写入一个指定记录并建立索引表项

		+ 逻辑记录是按信息在逻辑上的独立含义划分的单位,块是存储介质上连续信息所组成的区域,若干逻辑记录合并成一组写入一块(块因子:每块中的逻辑记录的个数)

	- 定长,变长,跨块记录

	- 记录键

		+ 定长逻辑记录:记录键+记录信息

		+ 变长逻辑记录:单个变长记录的记录键和记录信息的字节个数+记录键+记录信息

+ 文件的物理结构

	> 文件的物理结构指逻辑文件在物理存储空间中存放方法和组织关系

	- 构造文件物理结构的方法
	
		+ 计算法
		
		+ 指针法
	
	- 顺序文件(依次相邻的块)
	
		+ 顺序存取记录时速度较快
		
		+ 修改,插入和增加文件记录有难度;对可变长记录的处理很困难
	
	- 连接文件(串联文件)
	
		+ 使用连接字(指针)来表示文件中各个记录之间的关系
		
		+ 适宜于增删改但是失去性能
		
	- 直接文件(哈希文件)
	
		+ 步骤:构造hash函数,建立目录文件,查找文件,溢出处理
		
	- 索引文件
	
		+ 多重索引结构(计算:Slides: p77)
	
### 文件系统的功能与实现

+ 文件操作的实现

	- 把常用和正在使用的那些文件目录复制进主存

+ 磁盘结构

	- 超级块:占用1#号块,存放文件系统结构和管理信息
	
	- 索引节点区:2#~k+1#块,存放inode表

	- 数据区:k+2#~n#为数据块,存放文件的内容

+ 重要数据结构(Slides: pp86-90)

	- 用户打开文件表

	- 系统打开文件表

	- 主存活动inode表

+ 文件的系统调用

	- 创建

			int fd, mode;
			char *filenamep;
			fd = create(filenamep, mode);
	
	- 删除
			
			unlink(filenamep);
		
	- 打开
			
			int fd, mode;
			char *filenamep;
			fd = open(filenamep, mode);
		
	- 关闭
	
			int fd;
			close(fd);
		
	- 读文件
	
			int nr, fd, count;
			char *buf
			nr = read(fd, buf, count);

	- 写文件
	
			nw = write(fd, buf, count);
		
	- 随机存取
	
			long lseek;
			long offset;
			int whence, fd;
			lseek(fd, offset, whence);
	
+ 文件共享

	- 文件的静态共享
		
		+ 链接
	
	- 文件的动态共享
	
		+ 每个用户进程分别设置一个读oh写位移指针
	
	- 链接共享
		
		+ 拒绝创建跨越文件系统的硬链接

+ 文件空间管理

	- 文件分配:连续,非连续
	
	- ￼磁盘空闲空间管理方法:位示图,空闲区表,空闲块链
	
+ 虚拟文件系统

	- 应用层:无需考虑具体文件系统特性和物理存储介质
	
	- 虚拟层:定义与用户的一致性接口
	
	- 实现层:使用类似开关表技术进行具体文件系统转接
	
+ 文件系统安装和卸载

+ EXT2