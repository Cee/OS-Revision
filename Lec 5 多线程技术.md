# Lec 5 多线程技术

### 引入多线程的动机

+ 单线程的问题

	- 效率低,进程切换和通信开销大
	
	- 限制了进程并发的粒度
	
	- 不适合并行计算

+ 线程概念
	
	- 作为系统调度和分派的基本单位
	
	- 会被频繁地调度和切换
	
### 多线程结构的进程

	> 线程是进程的组成部分,每个进程内允许包含多个并发执行的实体

+ 线程组成

	- 唯一标识符和线程状态信息
	
	- 线程上下文
	
	- 核心栈
	
	- 局部变量,私有存储区
	
+ 优点

	- 快速切换
	
	- 减少开销
	
	- 易于通信
	
	- 便于共享资源
	
	- 并行程度提高

### 内核级线程的实现

+ 线程库

	> 在内核中运行的线程库,是通过内核来管理线程库的
	
	- 内核
	
		+ 保存进程的数据结构
		
		+ 建立维护线程的数据结构
		
		+ 提供一组应用程序编程接口(API)
	
+ 内核级线程(KLT, Kernel Level Threads)
	
	- 优点
	
		+ 多处理器可以调度多个并行
		
		+ 一个阻塞后内核能调度其他线程运行
		
		+ 数据结构和堆栈小时能够迅速切换提高系统效率
		
	- 缺点
	
		+ 在同一进程中控制权切换由用户态-内核态-用户态模式切换,系统开销大
		
### 用户级线程的实现

+ 用户级空间的线程库

	- 线程库是多线程应用程序的开发和运行支撑环境
	
+ 用户级线程(ULT, User Level Threads)

	- 有关线程管理的所有工作都由应用程序完成
	
	- 任何应用程序均需通过线程库进行程序设计,再与线程库连接后运行来实现多线程
	
	- 线程库是线程的运行支撑环境	
	
	- 优点
	
		+ 线程切换不需要内核特权方式
		
		+ 按应用特定需要来调度
		
		+ 能运行在任何OS上
		
	- 缺点
		
		+ 一个ULT阻塞能引起整个进程的阻塞
		
		+ ULT不能利用到多处理器

### 线程实现的混合策略

+ 组合用户级线程/内核级线程设施(Solaris)

+ 线程创建完全在用户空间中完成,线程的调度和同步也在程序中进行

+ 多个用户级线程被映射到一些内核级线程上

+ 程序员可以调整内核级线程的数目

+ 结合了用户级线程和内核级线程方法的优点

+ Solaris的进程与线程(Slides: pp35=37)
	
	- 内核级
	
	- 用户级
	
	- 轻量级